# 新建笔记(20231228)

1、流式对话接口

**正式接口URL**：http://116.204.85.243:8000/stream

==先用测试接口，后续调试成功改为正式接口==

**请求方式**：POST
**请求示例**：

```
{
  "query":"你是谁",
  "history":[["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]]
}
```

**参数说明**：

| 参数值     | 示例值                   | 参数类型 | 是否必填 | 参数描述    |
|---------|-----------------------|------|------|---------|
| query   | "你是谁"                 | 字符串  | 是    | 对话内容、问题 |
| history | [["你好", "你好！......"]] | 列表   | 是    | 对话历史记录  |

****注：history可为空，为对话历史记录。每次对话会返回用户传入的历史记录和最新的聊天记录，如果需要传入历史记录，可直接提取对话返回的列表，设置传入聊天历史的条数作为历史记录参数。
***
**成功响应示例**：

```event: delta
data: {"delta": "你", "response": "你", "finished": false}

event: delta
data: {"delta": "好", "response": "你好", "finished": false}

event: delta
data: {"delta": "！", "response": "你好！", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "finished": false}

event: delta
data: {"query": "你好", "delta": "[EOS]", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "history": [["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]], "finished": true}
```

**参数说明**：

| 参数值      | 内容说明                                             |
|----------|--------------------------------------------------|
| event    | sse协议中每触发一次事件会生成一个evnet，不可更改                     |
| data     | 每次事件返回的结果                                        |
| delta    | 每次事件返回一个短字符串，流式接口读取该字符串用于前端展示；如果返回[EOS]表示内容结束标志。 |
| response | 每次事件产生后返回的总内容                                    |
| query    | 表示用户对话内容或问题                                      |
| history  | 表示本次对话的历史记录，如果用户传入参数中有history，会一并返回给用户           |
| finished | 流式接口结束标志，false表示没有结束，true表示本次对话结束。               |

## 2、本地知识库流式对话接口

**正式接口UR**L：http://116.204.85.243:8000/local_doc_stream

==先用测试接口，后续调试成功改为正式接口==

**请求方式**：POST
**请求示例**：

```
{
  "query":"雾炮机可以将空气中的微小颗粒浓度降低吗",
  "history":[["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]]
}
```

**参数说明**：

| 参数值     | 示例值                   | 参数类型 | 是否必填 | 参数描述    |
|---------|-----------------------|------|------|---------|
| query   | "雾炮机可以将空气中的微小颗粒浓度降低吗" | 字符串  | 是    | 对话内容、问题 |
| history | [["你好", "你好！......"]] | 列表   | 是    | 对话历史记录  |

****注：history可为空，为对话历史记录。每次对话会返回用户传入的历史记录和最新的聊天记录，如果需要传入历史记录，可直接提取对话返回的列表，设置传入聊天历史的条数作为历史记录参数。
***
**成功响应示例**：

==①如果匹配到本地知识库内容==

```resp_idevent: delta
data: {"delta": "根据", "response": "根据", "finished": false}

event: delta
data: {"delta": "已知", "response": "根据已知", "finished": false}

event: delta
data: {"delta": "信息", "response": "根据已知信息", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。", "finished": false}

event: delta
data: {"query": "雾炮机可以将空气中的微小颗粒浓度降低吗", "delta": "[EOS]", "response": "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。", "history": [["雾炮机可以将空气中的微小颗粒浓度降低吗", "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。"]], "finished": true, "resp_content": [{"id": "lk_2", "content": "“雾炮”可以将空气中的微小颗粒浓度降低15%左右","que_title":"“雾炮”能将空气中的微小颗粒浓度降低到多少"}], "source_documents": true}
```

==②如果没有匹配到本地知识库内容==

```event: delta
data: {"delta": "你", "response": "你", "finished": false}

event: delta
data: {"delta": "好", "response": "你好", "finished": false}

event: delta
data: {"delta": "！", "response": "你好！", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "finished": false}

event: delta
data: {"query": "你好", "delta": "[EOS]", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "history": [["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]], "finished": true, "source_documents": false}
```

**参数说明**：

| 参数值              | 内容说明                                                                                                                                                 |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| event            | sse协议中每触发一次事件会生成一个evnet，不可更改                                                                                                                         |
| data             | 每次事件返回的结果                                                                                                                                            |
| delta            | 每次事件返回一个短字符串，流式接口读取该字符串用于前端展示；如果返回[EOS]表示内容结束标志。                                                                                                     |
| response         | 每次事件产生后返回的总内容                                                                                                                                        |
| query            | 表示用户对话内容或问题                                                                                                                                          |
| history          | 表示本次对话的历史记录，如果用户传入参数中有history，会一并返回给用户                                                                                                               |
| finished         | 流式接口结束标志，false表示没有结束，true表示本次对话结束。                                                                                                                   |
| source_documents | 是否匹配到本地知识库标识，如果匹配到为true，如果没有匹配到为false                                                                                                                |
| resp_content     | 如果匹配到本地知识库内容，则会返回所匹配内容的id和内容，如果没有匹配到，则没有该参数注意：id表示所匹配的id，content表示所匹配的内容；que_title表示所匹配内容的标题返回格式为列表形式，列表中存放id、que_title和content字典，目前列表中只存储一条匹配度最高的字典 |

## 3、添加单条知识到知识库接口

**正式接口URL**：http://116.204.85.243:8000/local_doc_qa/upload_one_knowledge

==先用测试接口，后续调试成功改为正式接口==

**请求方式**：POST
**请求示例**：

```
{
"local_knowledge_title":"PM2.5/PM10比值反映什么？",
"local_knowledge":"PM2.5，即大气颗粒物（Particulate Matter）的粒径小于或等于2.5微米的微小颗粒物。它是大气污染中的一个重要指标，对人体健康和环境质量有着重要影响。PM2.5的主要来源包括：1、工业排放：工业生产过程中会排放许多颗粒物，尤其是一些重工业和制造业。2、交通运输：汽车、卡车、船舶等交通工具的尾气排放中含有颗粒物，特别是柴油发动机产生的颗粒物较多。3、建筑施工：施工现场扬尘是一个重要的颗粒物来源，特别是在干燥、风速较高的条件下。4、农业活动：农业作业中，耕地的翻耕、种植、收割等过程会扬起土壤颗粒。5、生物质燃烧：包括木材、秸秆、生活垃圾等的燃烧会释放出颗粒物。6、燃煤：燃煤是重要的固体颗粒物来源，尤其是在一些地区的取暖季节。7、天然来源：如火山爆发、沙尘暴等天然现象也会产生颗粒物。8、工业生产过程中的化学反应：一些工业过程中的化学反应会产生细小颗粒。需要注意的是，PM2.5的来源是多样化的，其组成也会随着地区、季节和气象条件的不同而有所变化。因此，有效控制PM2.5污染需要综合考虑各种因素，采取相应的控制措施。",
"local_knowledge_id":"lk_0",
"knowledge_base_id":"dureader_robust_query_encoder"
}
```

**参数说明**：

| 参数值                   | 示例值                                                       | 参数类型   | 是否必填 | 参数描述      |
|-----------------------|-----------------------------------------------------------|--------|------|-----------|
| local_knowledge_title | "PM2.5/PM10比值反映什么？"                                       | string | 是    | 上传文本标题或问题 |
| local_knowledge       | "PM2.5，即大气颗粒物（Particulate Matter）的粒径小于或等于2.5微米的微小颗粒物。..." | string | 是    | 上传文本内容    |
| local_knowledge_id    | "lk_0"                                                    | string | 是    | 上传文本内容的id |
| knowledge_base_id     | "env_samples_3"                                           | string | 是    | 知识库id     |

**成功响应示例**：

```
{
    "code": 200,
    "msg": " lk_0 已上传至新的知识库，并已加载知识库，请开始提问。"
}
```

## 4、删除知识库某条知识接口

**正式接口URL**：http://116.204.85.243:8000/local_doc_qa/delete_knowledge

==先用测试接口，后续调试成功改为正式接口==

**请求方式**：DELETE
**请求示例**：

```
{
"local_knowledge_id":"lk_0",
"knowledge_base_id":"dureader_robust_query_encoder"
}
```

**参数说明**：

| 参数值                | 示例值                             | 参数类型   | 是否必填 | 参数描述        |
|--------------------|---------------------------------|--------|------|-------------|
| local_knowledge_id | "lk_0"                          | string | 是    | 要删除的文本内容的id |
| knowledge_base_id  | "dureader_robust_query_encoder" | string | 是    | 知识库id       |

**成功响应示例**：

```
{
    "code": 200,
    "msg": " lk_0 删除成功"
}
```

## 5、获取知识库中知识列表id接口

**正式接口URL**：http://116.204.85.243:8000/local_doc_qa/list_knowledge

==先用测试接口，后续调试成功改为正式接口==

**请求方式**：GET
**请求示例**：

```
{"knowledge_base_id":"dureader_robust_query_encoder"}
```

**参数说明：**
knowledge_base_id 表示访问的知识库的id，直接写成env_samples_3即可。

<br/>

**成功响应示例：**

```
{
    "code": 200,
    "msg": "success",
    "data": [
        "98644306232524842002253837",
        "98648899219462052252717306",
        "87509736484900192002159955",
        "98658536012265662252194179",
        "87487784798641272002656855"
    ]
}
```

其中，code表示状态码，返回200即为成功响应，data是返回的知识库中知识id的列表。

<br/>

## 6、获取知识库中某条知识对应向量列表id及内容接口

**正式接口URL**：http://116.204.85.243:8000/local_doc_qa/list_source_ids

<br/>

==先用测试接口，后续调试成功改为正式接口==
**请求方式**：GET
**请求示例**：

```
{
    "knowledge_base_id":"dureader_robust_query_encoder",
    "local_knowledge_id":"87487784798641272002656855"
}
```

**参数说明：**
knowledge_base_id 表示访问的知识库的id，直接写成env_samples_3即可;local_knowledge_id 表示知识库中某条知识的文本id。

**成功响应示例：**

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "45f02f1d-f580-4483-b063-f4e2bdf21a58",
            "content": "PM2.5/PM10比值反映城市一次颗粒物治理情况，比值越低，一次颗粒物排放源治理需加强。"
        },
        {
            "id": "6f907354-33a7-42cd-ab7d-2ef28a377d76",
            "content": "以5月份为例，颗粒物治理水平较好的城市，如珠海、重庆等城市能达到0.6以上；一般城市西安、郑州等在0.45-0.5左右；若低于0.4，则说明颗粒物治理水平较差，亟需加强扬尘管控力度"
        }
    ]
}
```

其中，code表示状态码，返回200即为成功响应，data是返回的该条知识对应的向量的id和内容的字典列表，id表示该条知识对应的向量id，content表示该id的向量内容。

<br/>

## 7、根据关键字搜索知识库中知识

**正式接口URL**：http://116.204.85.243:8000/local_doc_qa/list_document_by_query

==先用测试接口，后续调试成功改为正式接口==
**请求方式**：GET
**请求示例**：

```
{
    "knowledge_base_id":"dureader_robust_query_encoder",
    "query":"PM2.5"
}
```

**参数说明：**
knowledge_base_id 表示访问的知识库的id，必须指定知识库名称;query表示要搜索的字。

<br/>

**成功响应示例：**

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "45f02f1d-f580-4483-b063-f4e2bdf21a58",
            "content": "PM2.5/PM10比值反映城市一次颗粒物治理情况，比值越低，一次颗粒物排放源治理需加强。"
        },
        {
            "id": "6f907354-33a7-42cd-ab7d-2ef28a377d76",
            "content": "以5月份为例，颗粒物治理水平较好的城市，如珠海、重庆等城市能达到0.6以上；一般城市西安、郑州等在0.45-0.5左右；若低于0.4，则说明颗粒物治理水平较差，亟需加强扬尘管控力度"
        }
    ]
}
```

其中，code表示状态码，返回200即为成功响应，data是返回的该条知识对应的向量的id和内容的字典列表，id表示该条知识对应的向量id，content表示该id的向量内容。

<br/>

## 8、通过向量id删除指定向量

接口：http://116.204.85.243:8000/local_doc_qa/delete_vector

<br/>

```
{
    "knowledge_base_id":"dureader_robust_query_encoder",
    "vector_id":"123456"
}

```

## 9、要求

① 根据账号信息部分用户调用流式对话接口，部分用户调用本地知识库流式对话接口；
② 将历史聊天记录加入到对话中，可自行定制传输几条历史聊天记录；
③ 使用本地知识库流式对话接口时，如果返回匹配到本地知识库，则将在聊天末尾添加信息来源，效果如下：

![1696904977063.png](https://api.apifox.cn/api/v1/projects/2134873/resources/402653/image-preview)

***注意：目前如果匹配到知识库内容只返回一条匹配度最高的信息来源，所返回结果为列表，方便后续添加多条匹配内容；请根据返回id自行查询问题，点击来源链接可跳转到所匹配的内容
