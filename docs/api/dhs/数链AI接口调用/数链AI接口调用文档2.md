# 数链AI接口调用文档2

1、流式对话接口

**正式接口URL**：[http://116.204.85.243:8000/stream](http://116.204.85.243:8000/stream)

**测试接口URL**： [http://116.204.85.243:8080/stream](http://116.204.85.243:8080/stream)

***<u>==先用测试接口，后续调试成功改为正式接口==</u>***

**请求方式**：POST

**请求示例**：

```
{
  "query":"你是谁",
  "history":[["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]]
}
```

**参数说明**：

| 参数值     | 示例值                   | 参数类型 | 是否必填 | 参数描述    |
|---------|-----------------------|------|------|---------|
| query   | "你是谁"                 | 字符串  | 是    | 对话内容、问题 |
| history | [["你好", "你好！......"]] | 列表   | 是    | 对话历史记录  |

<u>****注：history可为空，为对话历史记录。每次对话会返回用户传入的历史记录和最新的聊天记录，如果需要传入历史记录，可直接提取对话返回的列表，设置传入聊天历史的条数作为历史记录参数。
***</u>

**成功响应示例**：

```
event: delta
data: {"delta": "你", "response": "你", "finished": false}

event: delta
data: {"delta": "好", "response": "你好", "finished": false}

event: delta
data: {"delta": "！", "response": "你好！", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "finished": false}

event: delta
data: {"query": "你好", "delta": "[EOS]", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "history": [["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]], "finished": true}
```

**参数说明**：

| 参数值      | 内容说明                                                  |
|----------|-------------------------------------------------------|
| event    | sse协议中每触发一次事件会生成一个evnet，不可更改                          |
| data     | 每次事件返回的结果                                             |
| delta    | 每次事件返回一个短字符串，流式接口读取该字符串用于前端展示；<br/>如果返回[EOS]表示内容结束标志。 |
| response | 每次事件产生后返回的总内容                                         |
| query    | 表示用户对话内容或问题                                           |
| history  | 表示本次对话的历史记录，<br/>如果用户传入参数中有history，会一并返回给用户           |
| finished | 流式接口结束标志，false表示没有结束，true表示本次对话结束。                    |

## 2、本地知识库流式对话接口

**正式接口URL**：[http://116.204.85.243:8000/local_doc_stream](http://116.204.85.243:8000/local_doc_stream)

**测试接口URL**：[http://116.204.85.243:8080/local_doc_stream](http://116.204.85.243:8080/local_doc_stream)

***<u>==先用测试接口，后续调试成功改为正式接口==</u>***

**请求方式**：POST

**请求示例**：

```
{
  "query":"雾炮机可以将空气中的微小颗粒浓度降低吗",
  "history":[["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]]
}
```

**参数说明**：

| 参数值     | 示例值                        | 参数类型 | 是否必填 | 参数描述    |
|---------|----------------------------|------|------|---------|
| query   | "雾炮机可以将空气中<br/>的微小颗粒浓度降低吗" | 字符串  | 是    | 对话内容、问题 |
| history | [["你好", "你好！......"]]      | 列表   | 是    | 对话历史记录  |

<u>****注：history可为空，为对话历史记录。每次对话会返回用户传入的历史记录和最新的聊天记录，如果需要传入历史记录，可直接提取对话返回的列表，设置传入聊天历史的条数作为历史记录参数。
***</u>

**成功响应示例**：

==①如果匹配到本地知识库内容==

```
resp_idevent: delta
data: {"delta": "根据", "response": "根据", "finished": false}

event: delta
data: {"delta": "已知", "response": "根据已知", "finished": false}

event: delta
data: {"delta": "信息", "response": "根据已知信息", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。", "finished": false}

event: delta
data: {"query": "雾炮机可以将空气中的微小颗粒浓度降低吗", "delta": "[EOS]", "response": "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。", "history": [["雾炮机可以将空气中的微小颗粒浓度降低吗", "根据已知信息,雾炮可以将空气中的微小颗粒浓度降低15%左右。"]], "finished": true, "resp_content": [{"id": "lk_2", "content": "“雾炮”可以将空气中的微小颗粒浓度降低15%左右","que_title":"“雾炮”能将空气中的微小颗粒浓度降低到多少"}], "source_documents": true}
```

==②如果没有匹配到本地知识库内容==

```
event: delta
data: {"delta": "你", "response": "你", "finished": false}

event: delta
data: {"delta": "好", "response": "你好", "finished": false}

event: delta
data: {"delta": "！", "response": "你好！", "finished": false}

            .
            .
            .
            
event: delta
data: {"delta": "", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "finished": false}

event: delta
data: {"query": "你好", "delta": "[EOS]", "response": "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？", "history": [["你好", "你好！我是数链生态 AI 小助手，由河北先进环保产业创新中心有限公司研发而成，专注于生态环境领域知识分享，为用户提供一站式的知识问答、数据解析、专家问诊、经验分享！请问有什么我可以帮助您的吗？"]], "finished": true, "source_documents": false}
```

**参数说明**：

<br/>

| 参数值              | 内容说明                                                                                                                                                                                              |
|------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| event            | sse协议中每触发一次事件会生成一个evnet，<br/>不可更改                                                                                                                                                                 |
| data             | 每次事件返回的结果                                                                                                                                                                                         |
| delta            | 每次事件返回一个短字符串，<br/>流式接口读取该字符串用于前端展示；<br/>如果返回[EOS]表示内容结束标志。                                                                                                                                        |
| response         | 每次事件产生后返回的总内容                                                                                                                                                                                     |
| query            | 表示用户对话内容或问题                                                                                                                                                                                       |
| history          | 表示本次对话的历史记录，<br/>如果用户传入参数中有history，会一并返回给用户                                                                                                                                                       |
| finished         | 流式接口结束标志，<br/>false表示没有结束，<br/>true表示本次对话结束。                                                                                                                                                      |
| source_documents | 是否匹配到本地知识库标识，<br/>如果匹配到为true，<br/>如果没有匹配到为false                                                                                                                                                   |
| resp_content     | 如果匹配到本地知识库内容，<br/>则会返回所匹配内容的id和内容，<br/>如果没有匹配到，则没有该参数<br/>注意：<br/>id表示所匹配的id，<br/>content表示所匹配的内容；<br/>que_title表示所匹配内容的标题<br/>返回格式为列表形式，<br/>列表中存放id、que_title和content字典，<br/>目前列表中只存储一条匹配度最高的字典 |

## 3、要求

① 根据账号信息部分用户调用流式对话接口，部分用户调用本地知识库流式对话接口；

② 将历史聊天记录加入到对话中，可自行定制传输几条历史聊天记录；

③ 使用本地知识库流式对话接口时，如果返回匹配到本地知识库，则将在聊天末尾添加信息来源，效果如下：

<img src="./b3068a46a74a98cccdaa3c91bfb46888.png" alt="screen-capture" style="zoom:50%;" />

***
注意：目前如果匹配到知识库内容只返回一条匹配度最高的信息来源，所返回结果为列表，方便后续添加多条匹配内容；请根据返回id自行查询问题，点击来源链接可跳转到所匹配的内容
*** 